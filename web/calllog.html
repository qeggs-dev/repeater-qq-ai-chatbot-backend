<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API调用日志分析仪表盘</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #2c3e50);
            color: #ecf0f1;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            margin-bottom: 20px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo i {
            font-size: 2.5rem;
            color: #3498db;
        }
        
        .logo h1 {
            font-size: 2.2rem;
            font-weight: 600;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            background: rgba(255, 255, 255, 0.08);
            padding: 12px 20px;
            border-radius: 10px;
        }
        
        select, button {
            padding: 10px 15px;
            border: none;
            background: rgba(44, 62, 80, 0.7);
            color: white;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        select:hover, button:hover {
            background: rgba(52, 152, 219, 0.8);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        
        button {
            background: linear-gradient(90deg, #3498db, #2ecc71);
            font-weight: bold;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .card {
            background: rgba(30, 40, 56, 0.8);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .card-header h2 {
            font-size: 1.4rem;
            font-weight: 500;
            color: #3498db;
        }
        
        .card-header i {
            font-size: 1.8rem;
            color: #2ecc71;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: rgba(44, 62, 80, 0.6);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            background: rgba(52, 152, 219, 0.3);
            transform: translateY(-3px);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin: 10px 0;
            color: #2ecc71;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #bdc3c7;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.9rem;
        }
        
        .data-table th {
            background: rgba(44, 62, 80, 0.8);
            padding: 12px 15px;
            text-align: left;
            color: #3498db;
        }
        
        .data-table td {
            padding: 10px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .data-table tr:hover {
            background: rgba(52, 152, 219, 0.1);
        }
        
        .footer {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            color: #bdc3c7;
            font-size: 0.9rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            header {
                flex-direction: column;
                gap: 20px;
            }
            
            .controls {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-chart-line"></i>
                <h1>API调用日志分析仪表盘</h1>
            </div>
            <div class="controls">
                <select id="timeUnit">
                    <option value="ms">毫秒</option>
                    <option value="s">秒</option>
                </select>
                <select id="sortOption">
                    <option value="user">按用户名排序</option>
                    <option value="time">按时间排序</option>
                    <option value="duration">按持续时间排序</option>
                </select>
                <button id="refreshBtn"><i class="fas fa-sync-alt"></i> 刷新数据</button>
            </div>
        </header>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">总请求数</div>
                <div class="stat-value" id="totalRequests">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">平均响应时间</div>
                <div class="stat-value" id="avgResponse">0 ms</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">总Token使用</div>
                <div class="stat-value" id="totalTokens">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">缓存命中率</div>
                <div class="stat-value" id="cacheHitRate">0%</div>
            </div>
        </div>
        
        <div class="dashboard">
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-stopwatch"></i> 用户平均请求处理时间</h2>
                    <i class="fas fa-chart-bar"></i>
                </div>
                <div class="chart-container">
                    <canvas id="durationChart"></canvas>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-layer-group"></i> 用户处理阶段耗时分布</h2>
                    <i class="fas fa-chart-pie"></i>
                </div>
                <div class="chart-container">
                    <canvas id="stagesChart"></canvas>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-brain"></i> 用户Token使用情况</h2>
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="chart-container">
                    <canvas id="tokensChart"></canvas>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-database"></i> 用户缓存效率分析</h2>
                    <i class="fas fa-chart-pie"></i>
                </div>
                <div class="chart-container">
                    <canvas id="cacheChart"></canvas>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-file-alt"></i> 用户上下文内容分析</h2>
                    <i class="fas fa-chart-bar"></i>
                </div>
                <div class="chart-container">
                    <canvas id="contentChart"></canvas>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-list"></i> 用户请求汇总</h2>
                    <i class="fas fa-table"></i>
                </div>
                <div class="table-container" style="overflow-x: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>用户名</th>
                                <th>请求次数</th>
                                <th>平均耗时</th>
                                <th>总Tokens</th>
                                <th>缓存命中率</th>
                            </tr>
                        </thead>
                        <tbody id="userSummaryTable">
                            <!-- Table rows will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>数据可视化仪表盘 &copy; 2025 | 数据来源: Repeater Calllog API | 最后更新: <span id="lastUpdate"></span></p>
        </div>
    </div>

    <script>
        // 在全局作用域初始化图表变量
        let durationChart = null;
        let stagesChart = null;
        let tokensChart = null;
        let cacheChart = null;
        let contentChart = null;

        // 时间单位转换因子
        const timeFactors = {
            'ns': 1,
            'ms': 1000000,
            's': 1000000000
        };

        // 获取当前时间单位
        function getTimeUnit() {
            return document.getElementById('timeUnit').value;
        }

        // 转换时间值
        function convertTime(ns, targetUnit) {
            return ns / timeFactors[targetUnit];
        }

        // 计算请求总耗时
        function calculateTotalDuration(request) {
            return request.task_end_time - request.task_start_time;
        }

        // 计算各阶段耗时
        function calculateStageDurations(request) {
            return {
                request: request.request_end_time - request.request_start_time,
                stream: request.stream_processing_end_time - request.stream_processing_start_time,
                prepare: request.call_prepare_end_time - request.call_prepare_start_time
            };
        }

        // 获取数据并渲染仪表盘
        async function fetchDataAndRender() {
            try {
                // 显示加载状态
                document.getElementById('totalRequests').textContent = "加载中...";
                document.getElementById('avgResponse').textContent = "加载中...";
                document.getElementById('totalTokens').textContent = "加载中...";
                document.getElementById('cacheHitRate').textContent = "加载中...";
                
                // 调用API获取真实数据
                const response = await fetch('/calllog');
                
                if (!response.ok) {
                    throw new Error(`API请求失败: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                
                renderDashboard(data);
                updateLastUpdated();
            } catch (error) {
                console.error('获取数据失败:', error);
                
                // 更新UI显示错误
                document.getElementById('totalRequests').textContent = "错误";
                document.getElementById('avgResponse').textContent = "错误";
                document.getElementById('totalTokens').textContent = "错误";
                document.getElementById('cacheHitRate').textContent = "错误";
                
                // 在表格区域显示错误信息
                const tableBody = document.getElementById('userSummaryTable');
                tableBody.innerHTML = `<tr><td colspan="5" style="text-align: center; color: #e74c3c;">${error.message}</td></tr>`;
                
                alert(`无法获取数据: ${error.message}`);
            }
        }

        // 按用户名分组数据
        function groupDataByUser(data) {
            const grouped = {};
            
            data.forEach(req => {
                const userName = req.user_name || '未知用户';
                if (!grouped[userName]) {
                    grouped[userName] = {
                        userName: userName,
                        requestCount: 0,
                        totalDuration: 0,
                        totalTokens: 0,
                        cacheHits: 0,
                        cacheMisses: 0,
                        requestTimes: [],
                        streamTimes: [],
                        prepareTimes: [],
                        promptTokens: 0,
                        completionTokens: 0,
                        contextLengths: [],
                        reasoningLengths: [],
                        newContentLengths: []
                    };
                }
                
                grouped[userName].requestCount++;
                const duration = calculateTotalDuration(req);
                grouped[userName].totalDuration += duration;
                grouped[userName].totalTokens += req.total_tokens;
                grouped[userName].cacheHits += req.cache_hit_count;
                grouped[userName].cacheMisses += req.cache_miss_count;
                
                // 记录各阶段时间
                const stages = calculateStageDurations(req);
                grouped[userName].requestTimes.push(stages.request);
                grouped[userName].streamTimes.push(stages.stream);
                grouped[userName].prepareTimes.push(stages.prepare);
                
                // Token 使用
                grouped[userName].promptTokens += req.prompt_tokens;
                grouped[userName].completionTokens += req.completion_tokens;
                
                // 内容长度
                grouped[userName].contextLengths.push(req.total_context_length);
                grouped[userName].reasoningLengths.push(req.reasoning_content_length);
                grouped[userName].newContentLengths.push(req.new_content_length);
            });
            
            // 转换为数组
            return Object.values(grouped);
        }

        // 渲染仪表盘
        function renderDashboard(data) {
            if (!data || data.length === 0) {
                const tableBody = document.getElementById('userSummaryTable');
                tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">没有可用的数据</td></tr>';
                return;
            }
            
            const timeUnit = getTimeUnit();
            const unitSuffix = timeUnit === 's' ? 's' : 'ms';
            
            // 按用户名分组数据
            const userData = groupDataByUser(data);
            
            // 根据排序选项排序
            const sortOption = document.getElementById('sortOption').value;
            if (sortOption === 'user') {
                userData.sort((a, b) => a.userName.localeCompare(b.userName));
            } else if (sortOption === 'duration') {
                userData.sort((a, b) => {
                    const avgA = a.totalDuration / a.requestCount;
                    const avgB = b.totalDuration / b.requestCount;
                    return avgB - avgA;
                });
            }
            
            // 更新统计信息
            updateStats(data, timeUnit, unitSuffix);
            
            // 渲染图表
            renderDurationChart(userData, timeUnit, unitSuffix);
            renderStagesChart(userData, timeUnit, unitSuffix);
            renderTokensChart(userData);
            renderCacheChart(userData);
            renderContentChart(userData);
            
            // 渲染用户汇总表格
            renderUserSummaryTable(userData, timeUnit, unitSuffix);
        }

        // 更新统计信息
        function updateStats(data, timeUnit, unitSuffix) {
            const totalRequests = data.length;
            document.getElementById('totalRequests').textContent = totalRequests;
            
            // 计算平均响应时间
            const totalDuration = data.reduce((sum, req) => {
                return sum + calculateTotalDuration(req);
            }, 0);
            
            const avgDuration = totalDuration / totalRequests;
            const convertedAvgDuration = convertTime(avgDuration, timeUnit).toFixed(2);
            document.getElementById('avgResponse').textContent = `${convertedAvgDuration} ${unitSuffix}`;
            
            // 计算总Token使用
            const totalTokens = data.reduce((sum, req) => sum + req.total_tokens, 0);
            document.getElementById('totalTokens').textContent = totalTokens;
            
            // 计算缓存命中率
            const totalCacheHits = data.reduce((sum, req) => sum + req.cache_hit_count, 0);
            const totalCacheMisses = data.reduce((sum, req) => sum + req.cache_miss_count, 0);
            const cacheHitRate = data.length > 0 ? 
                (totalCacheHits / (totalCacheHits + totalCacheMisses) * 100).toFixed(1) : 0;
            document.getElementById('cacheHitRate').textContent = `${cacheHitRate}%`;
        }

        // 渲染用户平均处理时间图表
        function renderDurationChart(userData, timeUnit, unitSuffix) {
            const ctx = document.getElementById('durationChart').getContext('2d');
            
            // 提取用户名和平均处理时间
            const labels = userData.map(user => user.userName);
            const avgDurations = userData.map(user => {
                const avgDuration = user.totalDuration / user.requestCount;
                return convertTime(avgDuration, timeUnit);
            });
            
            // 安全销毁现有图表实例
            if (durationChart) {
                durationChart.destroy();
            }
            
            durationChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `平均处理时间 (${unitSuffix})`,
                        data: avgDurations,
                        backgroundColor: 'rgba(52, 152, 219, 0.7)',
                        borderColor: 'rgba(41, 128, 185, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#ecf0f1'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: `时间 (${unitSuffix})`,
                                color: '#bdc3c7'
                            },
                            ticks: {
                                color: '#bdc3c7'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '用户名',
                                color: '#bdc3c7'
                            },
                            ticks: {
                                color: '#bdc3c7'
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // 渲染用户各阶段平均耗时图表
        function renderStagesChart(userData, timeUnit, unitSuffix) {
            const ctx = document.getElementById('stagesChart').getContext('2d');
            
            // 提取用户名和各阶段平均耗时
            const labels = userData.map(user => user.userName);
            const avgRequestTimes = userData.map(user => {
                const sum = user.requestTimes.reduce((a, b) => a + b, 0);
                return convertTime(sum / user.requestCount, timeUnit);
            });
            const avgStreamTimes = userData.map(user => {
                const sum = user.streamTimes.reduce((a, b) => a + b, 0);
                return convertTime(sum / user.requestCount, timeUnit);
            });
            const avgPrepareTimes = userData.map(user => {
                const sum = user.prepareTimes.reduce((a, b) => a + b, 0);
                return convertTime(sum / user.requestCount, timeUnit);
            });
            
            // 安全销毁现有图表实例
            if (stagesChart) {
                stagesChart.destroy();
            }
            
            stagesChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '平均请求处理',
                            data: avgRequestTimes,
                            backgroundColor: 'rgba(46, 204, 113, 0.7)',
                            borderColor: 'rgba(39, 174, 96, 1)',
                            borderWidth: 1
                        },
                        {
                            label: '平均流处理',
                            data: avgStreamTimes,
                            backgroundColor: 'rgba(155, 89, 182, 0.7)',
                            borderColor: 'rgba(142, 68, 173, 1)',
                            borderWidth: 1
                        },
                        {
                            label: '平均准备调用',
                            data: avgPrepareTimes,
                            backgroundColor: 'rgba(52, 152, 219, 0.7)',
                            borderColor: 'rgba(41, 128, 185, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#ecf0f1'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: `时间 (${unitSuffix})`,
                                color: '#bdc3c7'
                            },
                            ticks: {
                                color: '#bdc3c7'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '用户名',
                                color: '#bdc3c7'
                            },
                            ticks: {
                                color: '#bdc3c7'
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // 渲染用户Token使用情况图表
        function renderTokensChart(userData) {
            const ctx = document.getElementById('tokensChart').getContext('2d');
            
            // 提取用户名和Token使用
            const labels = userData.map(user => user.userName);
            const promptTokens = userData.map(user => user.promptTokens);
            const completionTokens = userData.map(user => user.completionTokens);
            
            // 安全销毁现有图表实例
            if (tokensChart) {
                tokensChart.destroy();
            }
            
            tokensChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '提示Token',
                            data: promptTokens,
                            backgroundColor: 'rgba(52, 152, 219, 0.7)',
                            borderColor: 'rgba(41, 128, 185, 1)',
                            borderWidth: 1
                        },
                        {
                            label: '完成Token',
                            data: completionTokens,
                            backgroundColor: 'rgba(46, 204, 113, 0.7)',
                            borderColor: 'rgba(39, 174, 96, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#ecf0f1'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Token数量',
                                color: '#bdc3c7'
                            },
                            ticks: {
                                color: '#bdc3c7'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '用户名',
                                color: '#bdc3c7'
                            },
                            ticks: {
                                color: '#bdc3c7'
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // 渲染用户缓存效率图表
        function renderCacheChart(userData) {
            const ctx = document.getElementById('cacheChart').getContext('2d');
            
            // 计算每个用户的缓存命中率
            const labels = userData.map(user => user.userName);
            const cacheHitRates = userData.map(user => {
                const total = user.cacheHits + user.cacheMisses;
                return total > 0 ? (user.cacheHits / total * 100) : 0;
            });
            
            // 安全销毁现有图表实例
            if (cacheChart) {
                cacheChart.destroy();
            }
            
            cacheChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '缓存命中率 (%)',
                        data: cacheHitRates,
                        backgroundColor: 'rgba(46, 204, 113, 0.7)',
                        borderColor: 'rgba(39, 174, 96, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#ecf0f1'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: '命中率 (%)',
                                color: '#bdc3c7'
                            },
                            ticks: {
                                color: '#bdc3c7'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '用户名',
                                color: '#bdc3c7'
                            },
                            ticks: {
                                color: '#bdc3c7'
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // 渲染用户上下文内容分析图表
        function renderContentChart(userData) {
            const ctx = document.getElementById('contentChart').getContext('2d');
            
            // 提取用户名和平均内容长度
            const labels = userData.map(user => user.userName);
            const avgContextLengths = userData.map(user => {
                const sum = user.contextLengths.reduce((a, b) => a + b, 0);
                return sum / user.requestCount;
            });
            const avgReasoningLengths = userData.map(user => {
                const sum = user.reasoningLengths.reduce((a, b) => a + b, 0);
                return sum / user.requestCount;
            });
            const avgNewContentLengths = userData.map(user => {
                const sum = user.newContentLengths.reduce((a, b) => a + b, 0);
                return sum / user.requestCount;
            });
            
            // 安全销毁现有图表实例
            if (contentChart) {
                contentChart.destroy();
            }
            
            contentChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '平均总上下文长度',
                            data: avgContextLengths,
                            backgroundColor: 'rgba(52, 152, 219, 0.7)',
                            borderColor: 'rgba(41, 128, 185, 1)',
                            borderWidth: 1
                        },
                        {
                            label: '平均推理内容长度',
                            data: avgReasoningLengths,
                            backgroundColor: 'rgba(46, 204, 113, 0.7)',
                            borderColor: 'rgba(39, 174, 96, 1)',
                            borderWidth: 1
                        },
                        {
                            label: '平均新内容长度',
                            data: avgNewContentLengths,
                            backgroundColor: 'rgba(155, 89, 182, 0.7)',
                            borderColor: 'rgba(142, 68, 173, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#ecf0f1'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '内容长度',
                                color: '#bdc3c7'
                            },
                            ticks: {
                                color: '#bdc3c7'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '用户名',
                                color: '#bdc3c7'
                            },
                            ticks: {
                                color: '#bdc3c7'
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // 渲染用户汇总表格
        function renderUserSummaryTable(userData, timeUnit, unitSuffix) {
            const tableBody = document.getElementById('userSummaryTable');
            tableBody.innerHTML = '';
            
            userData.forEach(user => {
                const avgDuration = convertTime(user.totalDuration / user.requestCount, timeUnit).toFixed(2);
                const cacheTotal = user.cacheHits + user.cacheMisses;
                const cacheHitRate = cacheTotal > 0 ? (user.cacheHits / cacheTotal * 100).toFixed(1) : 0;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.userName}</td>
                    <td>${user.requestCount}</td>
                    <td>${avgDuration} ${unitSuffix}</td>
                    <td>${user.totalTokens}</td>
                    <td>${cacheHitRate}%</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // 更新最后更新时间
        function updateLastUpdated() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = now.toLocaleString();
        }

        // 初始化仪表盘
        document.addEventListener('DOMContentLoaded', () => {
            fetchDataAndRender();
            
            // 添加事件监听器
            document.getElementById('refreshBtn').addEventListener('click', fetchDataAndRender);
            document.getElementById('timeUnit').addEventListener('change', () => fetchDataAndRender());
            document.getElementById('sortOption').addEventListener('change', () => fetchDataAndRender());
        });
    </script>
</body>
</html>