<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Repeater Chat Interface</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="/favicon.ico">
    <style>
        :root {
            --primary: #4f46e5;
            --primary-light: #818cf8;
            --secondary: #10b981;
            --dark: #1e293b;
            --light: #f8fafc;
            --gray: #94a3b8;
            --border: #e2e8f0;
            --user-msg: #e0e7ff;
            --bot-msg: #ffffff;
            --context-msg: #f0fdf4;
            --error: #ef4444;
            --context-divider: #dcfce7;
            --delete: #ef4444;
            --toggle-on: #10b981;
            --toggle-off: #94a3b8;
            --edit: #f59e0b;
            --menu-bg: #ffffff;
            --menu-hover: #f1f5f9;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            color: var(--dark);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            max-width: 1000px;
            width: 100%;
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 90vh;
        }
        
        .header {
            background: var(--primary);
            color: white;
            padding: 18px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .logo {
            width: 40px;
            height: 40px;
            background: var(--secondary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .logo i {
            font-size: 1.2rem;
        }
        
        .header h1 {
            font-size: 1.4rem;
            font-weight: 600;
        }
        
        .api-info {
            font-size: 0.9rem;
            background: rgba(255, 255, 255, 0.15);
            padding: 4px 12px;
            border-radius: 20px;
            font-family: monospace;
        }
        
        .favicon-container {
            position: absolute;
            right: 20px;
            bottom: -20px;
            width: 40px;
            height: 40px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }
        
        .favicon {
            width: 24px;
            height: 24px;
        }
        
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .chat-history {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
            background: var(--light);
            padding-top: 30px;
            position: relative;
        }
        
        .message {
            max-width: 80%;
            padding: 16px;
            border-radius: 12px;
            animation: fadeIn 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            position: relative;
            cursor: context-menu;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .message:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .user-message {
            background: var(--user-msg);
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
        
        .bot-message {
            background: var(--bot-msg);
            align-self: flex-start;
            border-bottom-left-radius: 4px;
            border: 1px solid var(--border);
        }
        
        .context-message {
            max-width: 80%;
            padding: 16px;
            border-radius: 12px;
            animation: fadeIn 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border: 1px solid #bbf7d0;
            opacity: 0.9;
        }

        .context-message.user {
            background: var(--user-msg);
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .context-message.assistant {
            background: var(--bot-msg);
            align-self: flex-start;
            border-bottom-left-radius: 4px;
            border: 1px solid var(--border);
        }

        .context-message.system {
            background: var(--context-msg);
            align-self: center;
        }

        .message-content {
            white-space: pre-wrap; /* 保留换行符和空格 */
            word-break: break-word; /* 长单词或URL换行 */
        }
        
        .context-divider {
            background: var(--context-divider);
            padding: 8px 16px;
            text-align: center;
            font-weight: 600;
            color: #166534;
            border-top: 2px solid #bbf7d0;
            border-bottom: 2px solid #bbf7d0;
            margin: 10px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .divider-line {
            flex: 1;
            height: 1px;
            background: linear-gradient(to right, transparent, #166534, transparent);
        }
        
        .message-header {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .message-header i {
            margin-right: 8px;
        }
        
        .reasoning {
            background: rgba(255, 255, 255, 0.7);
            border-left: 3px solid var(--primary-light);
            padding: 12px;
            margin-top: 12px;
            border-radius: 0 6px 6px 0;
            font-size: 0.9rem;
            color: #475569;
        }
        
        .image-container {
            margin-top: 12px;
            padding: 8px;
            background: white;
            border-radius: 8px;
            text-align: center;
            border: 1px solid var(--border);
        }
        
        .rendered-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: 6px;
        }
        
        .uuid {
            font-size: 0.8rem;
            color: var(--gray);
            margin-top: 6px;
            word-break: break-all;
        }
        
        .input-area {
            padding: 16px;
            border-top: 1px solid var(--border);
            background: white;
        }
        
        .input-row {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }
        
        .input-group {
            flex: 1;
            min-width: 180px;
            position: relative;
        }
        
        .input-group label {
            display: block;
            font-size: 0.85rem;
            color: var(--gray);
            margin-bottom: 4px;
            font-weight: 500;
        }
        
        select, input[type="text"] {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.95rem;
            background: white;
        }
        
        .toggle-group {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 24px;
        }
        
        .toggle-label {
            font-size: 0.9rem;
            color: var(--dark);
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--toggle-off);
            transition: .4s;
            border-radius: 24px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: var(--toggle-on);
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        .message-input-container {
            display: flex;
            gap: 12px;
            margin-top: 8px;
        }
        
        .message-input {
            flex: 1;
            padding: 14px 16px;
            border: 1px solid var(--border);
            border-radius: 12px;
            resize: none;
            font-size: 1rem;
            height: 60px;
            background: white;
        }
        
        .send-button {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            width: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .send-button:hover {
            background: var(--primary-light);
            transform: translateY(-2px);
        }
        
        .send-button:disabled {
            background: var(--gray);
            cursor: not-allowed;
            transform: none;
        }
        
        .context-button {
            background: var(--secondary);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }
        
        .context-button:hover {
            background: #059669;
            transform: translateY(-2px);
        }
        
        .delete-button {
            background: var(--delete);
        }
        
        .delete-button:hover {
            background: #dc2626;
        }
        
        .edit-button {
            background: var(--edit);
        }
        
        .edit-button:hover {
            background: #d97706;
        }
        
        .context-button:disabled {
            background: var(--gray);
            cursor: not-allowed;
            transform: none;
        }
        
        .toolbar {
            display: flex;
            justify-content: space-between;
            padding: 0 16px 8px;
            background: white;
        }
        
        .toolbar-buttons {
            display: flex;
            gap: 12px;
        }
        
        .status {
            text-align: center;
            padding: 8px;
            font-size: 0.9rem;
            color: var(--gray);
            min-height: 36px;
        }
        
        .typing-indicator {
            display: inline-flex;
            align-items: center;
            margin-left: 8px;
        }
        
        .typing-dot {
            width: 6px;
            height: 6px;
            background: var(--primary);
            border-radius: 50%;
            margin: 0 2px;
            animation: typing 1.4s infinite;
        }
        
        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-5px); }
        }
        
        .error {
            color: var(--error);
        }
        
        .context-count {
            background: var(--primary);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            margin-left: 5px;
        }
        
        .delete-confirm {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .confirm-dialog {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        
        .confirm-dialog p {
            margin-bottom: 20px;
            font-size: 1.1rem;
        }
        
        .dialog-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        
        .dialog-button {
            padding: 8px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .confirm-button {
            background: var(--delete);
            color: white;
        }
        
        .confirm-button:hover {
            background: #dc2626;
        }
        
        .cancel-button {
            background: var(--gray);
            color: white;
        }
        
        .cancel-button:hover {
            background: #64748b;
        }
        
        /* 右键菜单样式 */
        .context-menu {
            position: absolute;
            background: var(--menu-bg);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            width: 180px;
            display: none;
            overflow: hidden;
            border: 1px solid var(--border);
        }
        
        .context-menu-item {
            padding: 10px 16px;
            font-size: 0.9rem;
            color: var(--dark);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s;
        }
        
        .context-menu-item:hover {
            background: var(--menu-hover);
        }
        
        .context-menu-item i {
            width: 18px;
            text-align: center;
        }
        
        .context-menu-divider {
            height: 1px;
            background: var(--border);
            margin: 4px 0;
        }
        
        /* 用户自动完成下拉框 */
        .autocomplete {
            position: relative;
        }
        
        .autocomplete-items {
            position: absolute;
            border: 1px solid var(--border);
            border-bottom: none;
            border-top: none;
            z-index: 99;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 200px;
            overflow-y: auto;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            background: white;
            display: none;
        }
        
        .autocomplete-items div {
            padding: 10px;
            cursor: pointer;
            background-color: #fff;
            border-bottom: 1px solid var(--border);
        }
        
        .autocomplete-items div:hover {
            background-color: #e9e9ff;
        }
        
        .autocomplete-active {
            background-color: var(--primary) !important;
            color: #ffffff;
        }
        
        /* 编辑模态框 */
        .edit-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .edit-modal-content {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            max-width: 600px;
            width: 90%;
        }
        
        .edit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }
        
        .edit-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--dark);
        }
        
        .close-edit {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray);
        }
        
        .edit-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .edit-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .edit-label {
            font-weight: 500;
            color: var(--dark);
        }
        
        .edit-textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            resize: vertical;
            min-height: 120px;
            font-size: 1rem;
        }
        
        .edit-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 10px;
        }
        
        .edit-submit {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 20px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .edit-cancel {
            background: var(--gray);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 20px;
            cursor: pointer;
            font-weight: 500;
        }
        
        @media (max-width: 768px) {
            .container {
                height: 95vh;
                width: 95vw;
            }
            
            .header {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            
            .api-info {
                font-size: 0.8rem;
            }
            
            .input-row {
                flex-direction: column;
                gap: 10px;
            }
            
            .toggle-group {
                margin-top: 10px;
            }
            
            .message {
                max-width: 90%;
            }
            
            .favicon-container {
                right: 10px;
                bottom: -15px;
                width: 30px;
                height: 30px;
            }
            
            .favicon {
                width: 16px;
                height: 16px;
            }
            
            .toolbar {
                flex-direction: column;
                gap: 10px;
                align-items: center;
            }
            
            .toolbar-buttons {
                width: 100%;
                justify-content: center;
            }
            
            .context-menu {
                width: 160px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo-container">
                <div class="logo">
                    <i class="fas fa-brain"></i>
                </div>
                <h1>Repeater 聊天接口</h1>
            </div>
            <div class="api-info">API: /chat/completion/{user_id}</div>
            <div class="favicon-container">
                <img id="favicon" class="favicon" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%234f46e5'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z'/%3E%3C/svg%3E" alt="后端图标">
            </div>
        </div>
        
        <div class="main-content">
            <div class="chat-container">
                <div class="chat-history" id="chatHistory">
                    <div class="message bot-message">
                        <div class="message-header">
                            <i class="fas fa-robot"></i> 系统
                        </div>
                        <div class="message-content">
                            欢迎使用复读机聊天界面！您现在可以：
                            <ul style="margin-top: 8px; padding-left: 20px;">
                                <li>发送消息</li>
                                <li>右键点击消息进行撤回或编辑</li>
                                <li>在用户ID输入框查看用户列表</li>
                                <li>管理上下文消息</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <div class="toolbar">
                    <div class="toolbar-buttons">
                        <button class="context-button" id="updateContextBtn">
                            <i class="fas fa-sync-alt"></i> 更新上下文
                            <span class="context-count" id="contextCount">0</span>
                        </button>
                        <button class="context-button delete-button" id="deleteContextBtn">
                            <i class="fas fa-trash-alt"></i> 删除上下文
                        </button>
                    </div>
                    <div id="contextStatus">上下文未加载</div>
                </div>
                
                <div class="input-area">
                    <div class="input-row">
                        <div class="input-group autocomplete">
                            <label>用户ID</label>
                            <input type="text" id="userId" value="DefaultUser" placeholder="必选">
                            <div id="autocompleteList" class="autocomplete-items"></div>
                        </div>
                        
                        <div class="input-group">
                            <label>用户名称</label>
                            <input type="text" id="userName" placeholder="可选">
                        </div>
                        
                        <div class="input-group">
                            <label>模型类型</label>
                            <select id="modelType">
                                <option value="chat">Chat - 通用对话模型</option>
                                <option value="reasoner">Reasoner - 推理模型</option>
                                <option value="prover">Prover - 数学证明模型</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="input-row">
                        <div class="toggle-group">
                            <span class="toggle-label">加载预设提示</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="loadPrompt" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        
                        <div class="toggle-group">
                            <span class="toggle-label">启用图像渲染</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="rendering">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="message-input-container">
                        <textarea 
                            class="message-input" 
                            id="messageInput" 
                            placeholder="输入您的问题..." 
                            rows="1"
                        ></textarea>
                        <button class="send-button" id="sendButton">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="status" id="statusIndicator">
            准备就绪
        </div>
    </div>

    <!-- 右键菜单 -->
    <div id="contextMenu" class="context-menu">
        <div class="context-menu-item" id="editMenuItem">
            <i class="fas fa-edit"></i> 编辑消息
        </div>
        <div class="context-menu-item" id="withdrawMenuItem">
            <i class="fas fa-undo"></i> 撤回消息
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" id="copyMenuItem">
            <i class="fas fa-copy"></i> 复制内容
        </div>
    </div>
    
    <!-- 编辑模态框 -->
    <div id="editModal" class="edit-modal" style="display: none;">
        <div class="edit-modal-content">
            <div class="edit-header">
                <div class="edit-title">编辑消息内容</div>
                <button class="close-edit">&times;</button>
            </div>
            <div class="edit-form">
                <div class="edit-group">
                    <label class="edit-label">消息内容</label>
                    <textarea id="editContent" class="edit-textarea"></textarea>
                </div>
                <div class="edit-group">
                    <label class="edit-label">推理链（可选）</label>
                    <textarea id="editReasoning" class="edit-textarea" placeholder="修改推理链内容..."></textarea>
                </div>
                <div class="edit-buttons">
                    <button class="edit-cancel" id="cancelEdit">取消</button>
                    <button class="edit-submit" id="submitEdit">保存修改</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const chatHistory = document.getElementById('chatHistory');
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            const userIdInput = document.getElementById('userId');
            const userNameInput = document.getElementById('userName');
            const modelType = document.getElementById('modelType');
            const loadPrompt = document.getElementById('loadPrompt');
            const rendering = document.getElementById('rendering');
            const statusIndicator = document.getElementById('statusIndicator');
            const favicon = document.getElementById('favicon');
            const updateContextBtn = document.getElementById('updateContextBtn');
            const deleteContextBtn = document.getElementById('deleteContextBtn');
            const contextStatus = document.getElementById('contextStatus');
            const contextCount = document.getElementById('contextCount');
            const contextMenu = document.getElementById('contextMenu');
            const editMenuItem = document.getElementById('editMenuItem');
            const withdrawMenuItem = document.getElementById('withdrawMenuItem');
            const copyMenuItem = document.getElementById('copyMenuItem');
            const editModal = document.getElementById('editModal');
            const editContent = document.getElementById('editContent');
            const editReasoning = document.getElementById('editReasoning');
            const cancelEdit = document.getElementById('cancelEdit');
            const submitEdit = document.getElementById('submitEdit');
            const autocompleteList = document.getElementById('autocompleteList');
            const closeEdit = document.querySelector('.close-edit');
            
            // 存储上下文数据
            let contextData = [];
            // 当前选中的消息
            let selectedMessage = null;
            // 用户列表
            let userList = ['DefaultUser', 'AdminUser', 'TestUser', 'GuestUser', 'PremiumUser'];
            
            // 初始化用户列表
            fetchUserList();
            
            // 尝试获取后端favicon
            fetch('/favicon.ico')
                .then(response => {
                    if (response.ok) {
                        return response.blob();
                    }
                    throw new Error('Favicon not found');
                })
                .then(blob => {
                    const objectURL = URL.createObjectURL(blob);
                    favicon.src = objectURL;
                })
                .catch(error => {
                    console.log('使用默认图标:', error.message);
                });
            
            // 自动调整输入框高度
            messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight > 120 ? 120 : this.scrollHeight) + 'px';
            });

            function addMessageToChat(sender, content, reasoning = null, imageUrl = null, fileUuid = null) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}-message`;
                        
                const header = document.createElement('div');
                header.className = 'message-header';
                header.innerHTML = sender === 'user' 
                    ? '<i class="fas fa-user"></i> ' + (userNameInput.value || '您') 
                    : '<i class="fas fa-robot"></i> 复读机';
                        
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                contentDiv.innerHTML = content.replace(/\n/g, '<br>'); // 替换换行符为HTML换行标签
                        
                messageDiv.appendChild(header);
                messageDiv.appendChild(contentDiv);
                        
                if (reasoning) {
                    const reasoningDiv = document.createElement('div');
                    reasoningDiv.className = 'reasoning';
                    reasoningDiv.innerHTML = reasoning.replace(/\n/g, '<br>'); // 同样处理推理内容
                    contentDiv.appendChild(reasoningDiv);
                }
                
                if (imageUrl) {
                    const imageContainer = document.createElement('div');
                    imageContainer.className = 'image-container';
                    
                    const image = document.createElement('img');
                    image.src = imageUrl;
                    image.alt = '渲染图像';
                    image.className = 'rendered-image';
                    
                    imageContainer.appendChild(image);
                    
                    if (fileUuid) {
                        const uuidDiv = document.createElement('div');
                        uuidDiv.className = 'uuid';
                        uuidDiv.textContent = `UUID: ${fileUuid}`;
                        imageContainer.appendChild(uuidDiv);
                    }
                    
                    contentDiv.appendChild(imageContainer);
                }
                
                chatHistory.appendChild(messageDiv);
                chatHistory.scrollTop = chatHistory.scrollHeight;
            }
            
            // 发送消息到后端API
            async function sendMessageToAPI() {
                const message = messageInput.value.trim();
                if (!message) return;
                
                // 添加用户消息到聊天记录
                addMessageToChat('user', message);
                
                // 禁用发送按钮并清空输入框
                sendButton.disabled = true;
                messageInput.value = '';
                messageInput.style.height = '60px';
                
                // 显示加载状态
                setStatus('模型正在思考中...', true);
                
                try {
                    // 准备API参数
                    const userId = userIdInput.value;
                    const userName = userNameInput.value;
                    const apiUrl = `/chat/completion/${userId}`;
                    
                    // 准备表单数据
                    const formData = new FormData();
                    formData.append('message', message);
                    formData.append('user_name', userName);
                    formData.append('model_type', modelType.value);
                    formData.append('load_prompt', loadPrompt.checked ? 'true' : 'false');
                    formData.append('rendering', rendering.checked ? 'true' : 'false');
                    
                    // 调用后端API
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        throw new Error(`API请求失败: ${response.status} ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    
                    // 添加模型响应到聊天记录
                    addMessageToChat('bot', data.content, data.reasoning_content, 
                                      data.image_url, data.file_uuid);
                    
                    // 更新状态
                    setStatus(`请求成功完成 | 响应时间: ${new Date().toLocaleTimeString()}`);
                } catch (error) {
                    console.error('API调用错误:', error);
                    
                    // 显示错误消息
                    addMessageToChat('bot', '抱歉，处理您的请求时发生了错误。请稍后再试。', 
                                    `错误详情: ${error.message || '未知错误'}`);
                    
                    // 更新状态
                    setStatus(`错误: ${error.message}`, false, true);
                } finally {
                    // 重新启用发送按钮
                    sendButton.disabled = false;
                }
            }
            
            // 添加上下文消息（带分界线）
            function addContextMessages() {
                // 清除之前的上下文消息
                document.querySelectorAll('.context-message, .context-divider').forEach(el => el.remove());
                        
                if (contextData.length === 0) {
                    contextStatus.textContent = '没有可用的上下文数据';
                    contextCount.textContent = '0';
                    return;
                }
                
                // 添加上下文开始分界线
                const startDivider = createContextDivider('上下文开始');
                chatHistory.appendChild(startDivider);
                
                // 添加新的上下文消息
                contextData.forEach((item, index) => {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message context-message ${item.role}`;
                    messageDiv.dataset.index = index;
                    messageDiv.dataset.type = 'context';
                    
                    const header = document.createElement('div');
                    header.className = 'message-header';
                    
                    if (item.role === 'user') {
                        header.innerHTML = `<i class="fas fa-user"></i> ${userNameInput.value || '您'} [上下文]`;
                    } else if (item.role === 'assistant') {
                        header.innerHTML = `<i class="fas fa-robot"></i> 复读机 [上下文]`;
                    } else {
                        header.innerHTML = `<i class="fas fa-info-circle"></i> ${item.role} [上下文]`;
                    }

                    
                    contentDiv.innerHTML = item.content.replace(/\n/g, '<br>');
                    
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'message-content';
                    contentDiv.textContent = item.content;
                    
                    messageDiv.appendChild(header);
                    messageDiv.appendChild(contentDiv);
                    
                    // 如果有推理内容
                    if (item.reasoning_content) {
                        const reasoningDiv = document.createElement('div');
                        reasoningDiv.className = 'reasoning';
                        reasoningDiv.textContent = item.reasoning_content;
                        contentDiv.appendChild(reasoningDiv);
                    }
                    
                    // 添加到聊天记录
                    chatHistory.appendChild(messageDiv);
                });
                
                // 添加上下文结束分界线
                const endDivider = createContextDivider('上下文结束');
                chatHistory.appendChild(endDivider);
                
                contextStatus.textContent = `已加载 ${contextData.length} 条上下文`;
                contextCount.textContent = contextData.length;
                
                // 滚动到底部查看上下文
                chatHistory.scrollTop = chatHistory.scrollHeight;
            }
            
            // 创建上下文分界线
            function createContextDivider(text) {
                const divider = document.createElement('div');
                divider.className = 'context-divider';
                
                const line1 = document.createElement('div');
                line1.className = 'divider-line';
                
                const textSpan = document.createElement('span');
                textSpan.textContent = text;
                textSpan.style.padding = '0 10px';
                
                const line2 = document.createElement('div');
                line2.className = 'divider-line';
                
                divider.appendChild(line1);
                divider.appendChild(textSpan);
                divider.appendChild(line2);
                
                return divider;
            }
            
            // 获取上下文数据
            async function fetchContextData() {
                const userId = userIdInput.value;
                const apiUrl = `/userdata/context/get/${userId}`;
                
                // 禁用按钮并显示加载状态
                updateContextBtn.disabled = true;
                contextStatus.textContent = '加载中...';
                
                try {
                    // 调用上下文API
                    const response = await fetch(apiUrl);
                    
                    if (!response.ok) {
                        throw new Error(`上下文请求失败: ${response.status} ${response.statusText}`);
                    }
                    
                    contextData = await response.json();
                    
                    // 添加上下文消息到聊天记录
                    addContextMessages();
                    
                    // 更新状态
                    setStatus(`上下文已更新 | ${new Date().toLocaleTimeString()}`);
                } catch (error) {
                    console.error('上下文获取错误:', error);
                    contextStatus.textContent = `错误: ${error.message}`;
                    setStatus(`上下文错误: ${error.message}`, false, true);
                } finally {
                    // 重新启用按钮
                    updateContextBtn.disabled = false;
                }
            }
            
            // 删除上下文数据
            async function deleteContextData() {
                const userId = userIdInput.value;
                const apiUrl = `/userdata/context/delete/${userId}`;
                
                // 创建确认对话框
                const confirmDialog = document.createElement('div');
                confirmDialog.className = 'delete-confirm';
                confirmDialog.innerHTML = `
                    <div class="confirm-dialog">
                        <p>确定要删除所有上下文数据吗？此操作不可撤销。</p>
                        <div class="dialog-buttons">
                            <button class="dialog-button confirm-button" id="confirmDelete">确认删除</button>
                            <button class="dialog-button cancel-button" id="cancelDelete">取消</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(confirmDialog);
                
                // 等待用户选择
                return new Promise((resolve) => {
                    document.getElementById('confirmDelete').addEventListener('click', async () => {
                        // 禁用按钮并显示加载状态
                        deleteContextBtn.disabled = true;
                        contextStatus.textContent = '删除中...';
                        
                        try {
                            // 调用删除API
                            const response = await fetch(apiUrl, {
                                method: 'DELETE'
                            });
                            
                            if (!response.ok) {
                                throw new Error(`删除请求失败: ${response.status} ${response.statusText}`);
                            }
                            
                            // 清空本地上下文数据
                            contextData = [];
                            
                            // 更新UI
                            addContextMessages();
                            
                            // 更新状态
                            setStatus(`上下文已删除 | ${new Date().toLocaleTimeString()}`);
                            resolve(true);
                        } catch (error) {
                            console.error('删除上下文错误:', error);
                            contextStatus.textContent = `错误: ${error.message}`;
                            setStatus(`删除错误: ${error.message}`, false, true);
                            resolve(false);
                        } finally {
                            // 移除对话框并重新启用按钮
                            confirmDialog.remove();
                            deleteContextBtn.disabled = false;
                        }
                    });
                    
                    document.getElementById('cancelDelete').addEventListener('click', () => {
                        confirmDialog.remove();
                        resolve(false);
                    });
                });
            }
            
            // 添加消息到聊天记录
            function addMessageToChat(sender, content, reasoning = null, imageUrl = null, fileUuid = null) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}-message`;
                
                const header = document.createElement('div');
                header.className = 'message-header';
                header.innerHTML = sender === 'user' 
                    ? '<i class="fas fa-user"></i> ' + (userNameInput.value || '您') 
                    : '<i class="fas fa-robot"></i> 复读机';
                
                contentDiv.innerHTML = content.replace(/\n/g, '<br>');
                contentDiv.textContent = content;
                
                messageDiv.appendChild(header);
                messageDiv.appendChild(contentDiv);
                
                if (reasoning) {
                    const reasoningDiv = document.createElement('div');
                    reasoningDiv.className = 'reasoning';
                    reasoningDiv.textContent = reasoning;
                    contentDiv.appendChild(reasoningDiv);
                }
                
                if (imageUrl) {
                    const imageContainer = document.createElement('div');
                    imageContainer.className = 'image-container';
                    
                    const image = document.createElement('img');
                    image.src = imageUrl;
                    image.alt = '渲染图像';
                    image.className = 'rendered-image';
                    
                    imageContainer.appendChild(image);
                    
                    if (fileUuid) {
                        const uuidDiv = document.createElement('div');
                        uuidDiv.className = 'uuid';
                        uuidDiv.textContent = `UUID: ${fileUuid}`;
                        imageContainer.appendChild(uuidDiv);
                    }
                    
                    contentDiv.appendChild(imageContainer);
                }
                
                chatHistory.appendChild(messageDiv);
                
                // 滚动到底部
                chatHistory.scrollTop = chatHistory.scrollHeight;
            }
            
            // 更新状态指示器
            function setStatus(message, isLoading = false, isError = false) {
                statusIndicator.innerHTML = message;
                
                if (isLoading) {
                    statusIndicator.innerHTML += '<span class="typing-indicator"><span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span></span>';
                }
                
                if (isError) {
                    statusIndicator.classList.add('error');
                } else {
                    statusIndicator.classList.remove('error');
                }
            }
            
            // 获取用户列表
            async function fetchUserList() {
                try {
                    const response = await fetch('/userdata/context/userlist');
                    if (!response.ok) {
                        throw new Error('获取用户列表失败');
                    }
                    userList = await response.json();
                } catch (error) {
                    console.error('获取用户列表错误:', error);
                    // 使用默认用户列表
                    userList = ['DefaultUser', 'AdminUser', 'TestUser', 'GuestUser', 'PremiumUser'];
                }
            }
            
            // 显示右键菜单
            function showContextMenu(e, messageElement) {
                e.preventDefault();
                selectedMessage = messageElement;
                
                // 获取消息类型
                const isContextMessage = messageElement.classList.contains('context-message');
                
                // 根据消息类型设置菜单项可用性
                editMenuItem.style.display = isContextMessage ? 'flex' : 'none';
                withdrawMenuItem.style.display = isContextMessage ? 'flex' : 'none';
                
                // 定位菜单
                contextMenu.style.display = 'block';
                contextMenu.style.left = `${e.pageX}px`;
                contextMenu.style.top = `${e.pageY}px`;
            }
            
            // 隐藏右键菜单
            function hideContextMenu() {
                contextMenu.style.display = 'none';
            }
            
            // 编辑消息
            function editMessage() {
                if (!selectedMessage) return;

                const contentDiv = selectedMessage.querySelector('.message-content');
                // 获取原始HTML内容并转换<br>回\n
                const content = contentDiv.innerHTML.replace(/<br\s*\/?>/gi, '\n');

                const reasoningDiv = selectedMessage.querySelector('.reasoning');
                const reasoning = reasoningDiv ? reasoningDiv.innerHTML.replace(/<br\s*\/?>/gi, '\n') : '';

                editContent.value = content;
                editReasoning.value = reasoning;
                editModal.style.display = 'flex';
            }
            
            // 提交编辑
            async function submitMessageEdit() {
                if (!selectedMessage) return;

                try {
                    const index = parseInt(selectedMessage.dataset.index);
                    const userId = userIdInput.value;
                    const apiUrl = `/userdata/context/rewrite/${userId}`;

                    const formData = new FormData();
                    formData.append('index', index);
                    // 保留原始换行符
                    formData.append('content', editContent.value);
                    formData.append('reasoning_content', editReasoning.value);

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        throw new Error(`编辑请求失败: ${response.status} ${response.statusText}`);
                    }

                    contextData[index].content = editContent.value;
                    contextData[index].reasoning_content = editReasoning.value;
                    addContextMessages();
                    editModal.style.display = 'none';
                    setStatus(`消息已成功编辑 | ${new Date().toLocaleTimeString()}`);
                } catch (error) {
                    console.error('编辑消息错误:', error);
                    setStatus(`编辑错误: ${error.message}`, false, true);
                }
            }
            
            // 撤回消息
            async function withdrawMessage() {
                if (!selectedMessage) return;
                
                try {
                    // 获取消息索引
                    const index = parseInt(selectedMessage.dataset.index);
                    
                    // 准备API参数
                    const userId = userIdInput.value;
                    const apiUrl = `/userdata/context/withdraw/${userId}`;
                    
                    // 准备表单数据
                    const formData = new FormData();
                    formData.append('index', index);
                    
                    // 调用撤回API
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        throw new Error(`撤回请求失败: ${response.status} ${response.statusText}`);
                    }
                    
                    // 从本地数据中移除
                    contextData.splice(index, 1);
                    
                    // 更新UI
                    addContextMessages();
                    
                    // 更新状态
                    setStatus(`消息已成功撤回 | ${new Date().toLocaleTimeString()}`);
                } catch (error) {
                    console.error('撤回消息错误:', error);
                    setStatus(`撤回错误: ${error.message}`, false, true);
                }
            }
            
            // 复制消息内容
            function copyMessageContent() {
                if (!selectedMessage) return;
                
                const contentDiv = selectedMessage.querySelector('.message-content');
                const content = contentDiv.textContent;
                
                navigator.clipboard.writeText(content)
                    .then(() => {
                        setStatus('消息内容已复制到剪贴板');
                    })
                    .catch(err => {
                        console.error('复制失败:', err);
                        setStatus('复制失败，请手动复制', false, true);
                    });
            }
            
            // 用户ID自动完成
            function setupAutocomplete() {
                userIdInput.addEventListener('input', function() {
                    const val = this.value.toLowerCase();
                    autocompleteList.innerHTML = '';
                    
                    if (!val) {
                        autocompleteList.style.display = 'none';
                        return;
                    }
                    
                    // 过滤匹配的用户
                    const matches = userList.filter(user => 
                        user.toLowerCase().includes(val)
                    );
                    
                    if (matches.length === 0) {
                        autocompleteList.style.display = 'none';
                        return;
                    }
                    
                    // 添加匹配项到列表
                    matches.forEach(user => {
                        const item = document.createElement('div');
                        item.textContent = user;
                        item.addEventListener('click', function() {
                            userIdInput.value = user;
                            autocompleteList.style.display = 'none';
                        });
                        autocompleteList.appendChild(item);
                    });
                    
                    autocompleteList.style.display = 'block';
                });
                
                // 点击外部时隐藏自动完成列表
                document.addEventListener('click', function(e) {
                    if (e.target !== userIdInput) {
                        autocompleteList.style.display = 'none';
                    }
                });
            }
            
            // 事件监听器
            sendButton.addEventListener('click', sendMessageToAPI);
            updateContextBtn.addEventListener('click', fetchContextData);
            deleteContextBtn.addEventListener('click', deleteContextData);
            
            messageInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessageToAPI();
                }
            });
            
            // 右键菜单事件
            chatHistory.addEventListener('contextmenu', function(e) {
                if (e.target.closest('.message')) {
                    showContextMenu(e, e.target.closest('.message'));
                }
            });
            
            document.addEventListener('click', hideContextMenu);
            
            editMenuItem.addEventListener('click', editMessage);
            withdrawMenuItem.addEventListener('click', withdrawMessage);
            copyMenuItem.addEventListener('click', copyMessageContent);
            
            // 编辑模态框事件
            closeEdit.addEventListener('click', function() {
                editModal.style.display = 'none';
            });
            
            cancelEdit.addEventListener('click', function() {
                editModal.style.display = 'none';
            });
            
            submitEdit.addEventListener('click', submitMessageEdit);
            
            // 初始化自动完成
            setupAutocomplete();
            
            // 添加一些示例消息
            setTimeout(() => {
                addMessageToChat('user', '你好，我想了解如何编辑消息？');
                addMessageToChat('bot', '您可以通过右键点击上下文消息，然后选择"编辑消息"选项来修改内容。', 
                                '用户询问编辑消息的功能，提供编辑操作说明');
            }, 1000);
        });
    </script>
</body>
</html>